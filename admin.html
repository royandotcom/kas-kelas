<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Kas Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Poppins', sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div id="app-container" class="max-w-4xl mx-auto space-y-6" style="display: none;">
        
        <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg text-center">
            <h2 class="text-sm opacity-80 uppercase tracking-wide">Total Saldo Kas Saat Ini</h2>
            <h1 class="text-4xl font-bold mt-2" id="totalSaldo">Loading...</h1>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                <h3 class="font-bold text-lg mb-4 text-gray-700">üí∞ Bayar Kas Siswa</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500">Pilih Nama Siswa</label>
                        <select id="pilihSiswa" class="w-full p-3 border rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-300"></select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Nominal (Rp)</label>
                        <input type="number" id="jumlahSiswa" class="w-full p-3 border rounded-lg" placeholder="Contoh: 5000">
                    </div>
                    <button onclick="bayarKas()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">Simpan Pembayaran</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-orange-500">
                <h3 class="font-bold text-lg mb-4 text-gray-700">üìù Transaksi Lain</h3>
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <select id="jenisTransaksi" class="w-1/3 p-3 border rounded-lg bg-gray-50">
                            <option value="keluar">üî¥ Keluar</option>
                            <option value="masuk">üü¢ Masuk</option>
                        </select>
                        <input type="text" id="keteranganLain" class="w-2/3 p-3 border rounded-lg" placeholder="Ket: Beli Sapu...">
                    </div>
                    <div>
                         <label class="text-xs text-gray-500">Nominal (Rp)</label>
                        <input type="number" id="jumlahLain" class="w-full p-3 border rounded-lg" placeholder="Nominal">
                    </div>
                    <button onclick="transaksiLain()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition">Catat Transaksi</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-700">üìã Data Kas Siswa</h3>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Target: Rp<span id="targetText">...</span></span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 text-sm">
                        <tr><th class="p-4">Nama</th><th class="p-4">Total</th><th class="p-4 text-center">Status</th></tr>
                    </thead>
                    <tbody id="tabelSiswa" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b"><h3 class="font-bold text-gray-700">History Terbaru</h3></div>
            <div class="overflow-x-auto max-h-64">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr><th class="p-3">Tanggal</th><th class="p-3">Ket</th><th class="p-3">Jenis</th><th class="p-3 text-right">Jml</th></tr>
                    </thead>
                    <tbody id="tabelRiwayat" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP VARIABEL ---
        let db = null; 
        const TANGGAL_MULAI_KAS = new Date('2026-01-06T08:00:00'); 
        const BIAYA_PER_MINGGU = 5000;

        // --- 2. CEK PASSWORD SAAT LOAD ---
        window.onload = function() {
            // Delay 0.5 detik untuk memastikan Library Supabase siap
            setTimeout(() => {
                const passInput = prompt("üîê Masukkan Password Bendahara:");
                
                // PASSWORD: sayang
                if (passInput === "sayang") {
                    document.getElementById('app-container').style.display = 'block'; // Munculkan Website
                    initDatabase(); // Mulai Koneksi
                } else {
                    alert("Password Salah!");
                    window.location.href = "index.html";
                }
            }, 500);
        };

        // --- 3. KONEKSI DATABASE ---
        function initDatabase() {
            const sbUrl = 'https://ffsclgcnkqedozepmvbx.supabase.co';
            const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmc2NsZ2Nua3FlZG96ZXBtdmJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTcwOTAsImV4cCI6MjA4MzE5MzA5MH0.W8teVO6_RYy72cu7U1WL89CKAyaY2VIUoZVqzYzT7rM'; 

            try {
                // Cek Library
                if (typeof supabase === 'undefined') throw new Error("Library Supabase gagal dimuat.");

                // Koneksi (Perhatikan: tidak pakai underscore)
                db = supabase.createClient(sbUrl, sbKey);
                console.log("Database terhubung!");
                loadData();
            } catch (error) {
                console.error(error);
                alert("Error Koneksi: " + error.message);
            }
        }

        // --- 4. LOGIKA HITUNG TARGET ---
        function hitungTargetSaatIni() {
            const sekarang = new Date();
            const selisih = sekarang - TANGGAL_MULAI_KAS;
            if (selisih < 0) return { mingguKe: 0, nominal: 0 };
            const mingguKe = Math.floor(selisih / (1000 * 60 * 60 * 24 * 7)) + 1;
            return { mingguKe, nominal: mingguKe * BIAYA_PER_MINGGU };
        }

        // --- 5. LOAD DATA ---
        async function loadData() {
            if (!db) return;

            const target = hitungTargetSaatIni();
            document.getElementById('targetText').innerText = target.nominal.toLocaleString();

            // A. Siswa
            const { data: listSiswa, error } = await db.from('siswa').select('*').order('nama');
            if (error) return alert("Gagal ambil data siswa. Cek Console.");

            const tabel = document.getElementById('tabelSiswa');
            const dropdown = document.getElementById('pilihSiswa');
            tabel.innerHTML = '';
            dropdown.innerHTML = '<option value="">-- Pilih Siswa --</option>';

            listSiswa.forEach(siswa => {
                const tunggakan = target.nominal - siswa.total_bayar;
                let statusBadge = tunggakan <= 0 
                    ? `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">LUNAS</span>`
                    : `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold">MINUS</span>`;
                
                let infoKurang = tunggakan > 0 ? `<br><span class="text-xs text-red-600 font-bold">Kurang: Rp ${tunggakan.toLocaleString()}</span>` : '';

                tabel.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-4 font-medium">${siswa.nama}</td>
                        <td class="p-4 text-gray-600">Rp ${siswa.total_bayar.toLocaleString()}${infoKurang}</td>
                        <td class="p-4 text-center">${statusBadge}</td>
                    </tr>`;
                
                dropdown.innerHTML += `<option value="${siswa.id}" data-nama="${siswa.nama}" data-total="${siswa.total_bayar}">${siswa.nama}</option>`;
            });

            // B. Riwayat
            const { data: listTrans } = await db.from('transaksi').select('*').order('tanggal', {ascending:false});
            let saldo = 0;
            const tabelLog = document.getElementById('tabelRiwayat');
            tabelLog.innerHTML = '';

            if (listTrans) {
                listTrans.forEach(tr => {
                    if (tr.jenis === 'masuk') saldo += tr.jumlah; else saldo -= tr.jumlah;
                    if (tabelLog.childElementCount < 10) {
                        const warna = tr.jenis === 'masuk' ? 'text-green-600' : 'text-red-600';
                        tabelLog.innerHTML += `
                            <tr>
                                <td class="p-3 text-xs text-gray-400">${new Date(tr.tanggal).toLocaleDateString()}</td>
                                <td class="p-3">${tr.keterangan}</td>
                                <td class="p-3 font-bold ${warna}">${tr.jenis}</td>
                                <td class="p-3 text-right">Rp ${tr.jumlah.toLocaleString()}</td>
                            </tr>`;
                    }
                });
            }
            document.getElementById('totalSaldo').innerText = "Rp " + saldo.toLocaleString();
        }

        // --- 6. TRANSAKSI ---
        async function bayarKas() {
            const dropdown = document.getElementById('pilihSiswa');
            const id = dropdown.value;
            const nama = dropdown.options[dropdown.selectedIndex]?.getAttribute('data-nama');
            const currentTotal = parseInt(dropdown.options[dropdown.selectedIndex]?.getAttribute('data-total') || 0);
            const jumlah = parseInt(document.getElementById('jumlahSiswa').value);

            if (!id || !jumlah) return alert("Pilih siswa dan isi jumlah!");

            await db.from('siswa').update({ total_bayar: currentTotal + jumlah }).eq('id', id);
            await db.from('transaksi').insert({ jenis: 'masuk', keterangan: `Kas: ${nama}`, jumlah: jumlah });

            alert("Berhasil!");
            document.getElementById('jumlahSiswa').value = '';
            loadData();
        }

        async function transaksiLain() {
            const jenis = document.getElementById('jenisTransaksi').value;
            const ket = document.getElementById('keteranganLain').value;
            const jumlah = parseInt(document.getElementById('jumlahLain').value);

            if (!ket || !jumlah) return alert("Lengkapi data!");

            await db.from('transaksi').insert({ jenis, keterangan: ket, jumlah });
            alert("Tersimpan!");
            document.getElementById('keteranganLain').value = '';
            document.getElementById('jumlahLain').value = '';
            loadData();
        }
    </script>
</body>
</html>