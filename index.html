<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Kas Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Poppins', sans-serif; }</style>
</head>
<body class="bg-blue-50 min-h-screen p-4 md:p-8">

    <div class="max-w-3xl mx-auto space-y-6">
        
        <div class="text-center space-y-2">
            <h1 class="text-2xl font-bold text-gray-800">Transparansi Kas Kelas</h1>
            <p class="text-sm text-gray-500">Data ini diperbarui secara real-time</p>
            <div class="bg-white p-4 rounded-lg shadow-sm inline-block border border-blue-100">
                <span class="text-xs text-gray-500 uppercase">Total Saldo Terkumpul</span>
                <div class="text-3xl font-bold text-blue-600 mt-1" id="totalSaldo">Loading...</div>
            </div>
        </div>

        <div class="relative">
            <input type="text" id="searchInput" onkeyup="filterSiswa()" 
                placeholder="ðŸ” Cari nama kamu disini..." 
                class="w-full p-4 pl-12 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-blue-400 outline-none">
        </div>

        <div class="bg-blue-600 text-white p-3 rounded-lg text-center text-sm shadow-md">
            <span id="targetText">Memuat data minggu...</span>
        </div>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 text-sm">
                        <tr>
                            <th class="p-4">Nama Siswa</th>
                            <th class="p-4">Total Setor</th>
                            <th class="p-4 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="tabelSiswa" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-4 border-b bg-gray-50">
                <h3 class="font-bold text-gray-700 text-sm">ðŸ“œ Riwayat Transaksi Terakhir</h3>
            </div>
            <div class="overflow-y-auto max-h-60">
                <table class="w-full text-left text-sm">
                    <tbody id="tabelRiwayat" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center text-xs text-gray-400 mt-8">
            <p>Ingin input data?</p>
            <a href="admin.html" class="text-blue-400 hover:underline">Login Bendahara</a>
        </div>

    </div>

    <script>
        // --- KONFIGURASI ---
        const TANGGAL_MULAI_KAS = new Date('2025-01-06T08:00:00'); 
        const BIAYA_PER_MINGGU = 5000;
        
        // --- SETUP SUPABASE ---
        // GANTI DENGAN KUNCI BARU KAMU!
        const supabaseUrl = 'https://ffsclgcnkqedozepmvbx.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmc2NsZ2Nua3FlZG96ZXBtdmJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTcwOTAsImV4cCI6MjA4MzE5MzA5MH0.W8teVO6_RYy72cu7U1WL89CKAyaY2VIUoZVqzYzT7rM'; 
        
        // Inisialisasi Database
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        // --- LOGIKA PROGRAM ---
        function hitungTargetSaatIni() {
            const sekarang = new Date();
            const selisihWaktu = sekarang - TANGGAL_MULAI_KAS;
            if (selisihWaktu < 0) return { mingguKe: 0, nominal: 0 };
            const mingguKe = Math.floor(selisihWaktu / (1000 * 60 * 60 * 24 * 7)) + 1;
            return { mingguKe, nominal: mingguKe * BIAYA_PER_MINGGU };
        }

        async function loadData() {
            const dataTarget = hitungTargetSaatIni();
            document.getElementById('targetText').innerHTML = 
                `ðŸ”” Saat ini <b>Minggu ke-${dataTarget.mingguKe}</b>. Target Wajib: <b>Rp ${dataTarget.nominal.toLocaleString()}</b>`;

            // 1. AMBIL DATA SISWA
            const { data: dataSiswa, error } = await db.from('siswa').select('*').order('nama');
            
            if(error) {
                console.error(error);
                return alert("Gagal mengambil data. Cek Key Supabase!");
            }

            const tabelSiswa = document.getElementById('tabelSiswa');
            tabelSiswa.innerHTML = '';

            dataSiswa.forEach(siswa => {
                const tunggakan = dataTarget.nominal - siswa.total_bayar;
                let statusBadge, infoUang;

                if (tunggakan <= 0) {
                    statusBadge = `<span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold">LUNAS</span>`;
                    infoUang = `<div class="text-gray-900 font-bold">Rp ${siswa.total_bayar.toLocaleString()}</div>`;
                } else {
                    statusBadge = `<span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold">KURANG</span>`;
                    infoUang = `
                        <div class="text-gray-900 font-bold">Rp ${siswa.total_bayar.toLocaleString()}</div>
                        <div class="text-xs text-red-500 font-semibold">(-Rp ${tunggakan.toLocaleString()})</div>
                    `;
                }

                tabelSiswa.innerHTML += `
                    <tr class="hover:bg-gray-50 transition item-siswa">
                        <td class="p-4 font-medium text-gray-700 nama-siswa">${siswa.nama}</td>
                        <td class="p-4">${infoUang}</td>
                        <td class="p-4 text-center">${statusBadge}</td>
                    </tr>
                `;
            });

            // 2. AMBIL RIWAYAT
            const { data: allTrans } = await db.from('transaksi').select('*').order('tanggal', {ascending:false});
            let saldoTotal = 0;
            const tabelRiwayat = document.getElementById('tabelRiwayat');
            tabelRiwayat.innerHTML = '';

            if(allTrans) {
                allTrans.forEach(tr => {
                    if(tr.jenis === 'masuk') saldoTotal += tr.jumlah; else saldoTotal -= tr.jumlah;
                    
                    if(tabelRiwayat.childElementCount < 10) {
                        const warna = tr.jenis === 'masuk' ? 'text-green-600' : 'text-red-600';
                        const icon = tr.jenis === 'masuk' ? 'â¬‡ï¸' : 'â¬†ï¸';
                        tabelRiwayat.innerHTML += `
                            <tr>
                                <td class="p-3 text-xs text-gray-400 w-24">${new Date(tr.tanggal).toLocaleDateString()}</td>
                                <td class="p-3"><div class="font-medium text-gray-700">${tr.keterangan}</div></td>
                                <td class="p-3 text-right font-bold ${warna}">${icon} Rp ${tr.jumlah.toLocaleString()}</td>
                            </tr>`;
                    }
                });
            }
            document.getElementById('totalSaldo').innerText = `Rp ${saldoTotal.toLocaleString()}`;
        }

        function filterSiswa() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const baris = document.getElementsByClassName('item-siswa');
            for (let i = 0; i < baris.length; i++) {
                const nama = baris[i].getElementsByClassName('nama-siswa')[0].innerText.toLowerCase();
                baris[i].style.display = nama.includes(input) ? "" : "none";
            }
        }

        loadData();
    </script>
</body>
</html>